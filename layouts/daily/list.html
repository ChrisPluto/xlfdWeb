{{ define "main" }}

{{ $dailyPages := where .Site.RegularPages "Section" "daily" }}
{{ $insightsPages := where .Site.RegularPages "Section" "insights" }}
{{ $thoughtsPages := where .Site.RegularPages "Section" "thoughts" }}
{{ $techPages := where .Site.RegularPages "Section" "tech" }}
{{ $essaysPages := where .Site.RegularPages "Section" "essays" }}

{{ $latestPage := index (sort $dailyPages "Date" "desc") 0 }}
{{ $totalDays := 111 }}
{{ $cost := $latestPage.Params.cost }}
{{ $yield := $latestPage.Params.yield }}

<style>
.with-sidebar { display: flex; gap: 0; max-width: 1400px; margin: 0 auto; }
.sidebar-nav { width: 300px; flex: 0 0 300px; position: sticky; top: 64px; height: calc(100vh - 64px); overflow-y: auto; border-right: 1px solid #e5e7eb; background: #fafafa; padding: 16px 0; }
.sidebar-group { margin-bottom: 8px; }
.sidebar-group-header { display: flex; align-items: center; gap: 10px; padding: 12px 16px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; }
.sidebar-links { padding: 0 8px; }
.sidebar-parent { display: flex; align-items: center; padding: 10px 12px; border-radius: 8px; font-size: 14px; color: #4b5563; cursor: pointer; text-decoration: none; }
.sidebar-parent:hover { background: #f3f4f6; color: #1a1dc3; }
.sidebar-chevron { font-size: 11px; color: #9ca3af; transition: transform 0.2s; margin-left: auto; }
.sidebar-parent.open > .sidebar-chevron { transform: rotate(90deg); }
.sidebar-children { display: none; padding-left: 20px; margin-top: 4px; }
.sidebar-parent.open + .sidebar-children { display: block; }
.sidebar-year { display: flex; align-items: center; padding: 8px 10px; border-radius: 6px; font-size: 14px; color: #4b5563; cursor: pointer; }
.sidebar-year.open > .sidebar-chevron { transform: rotate(90deg); }
.sidebar-months { display: none; padding-left: 16px; }
.sidebar-year.open + .sidebar-months { display: block; }
.sidebar-month { padding: 6px 10px; font-size: 13px; color: #6b7280; border-radius: 4px; cursor: pointer; display: block; text-decoration: none; }
.sidebar-month:hover, .sidebar-month.active { background: #f3f4f6; color: #1a1dc3; }
.sidebar-article { display: block; padding: 8px 10px; font-size: 13px; color: #6b7280; border-radius: 4px; text-decoration: none; cursor: pointer; }
.sidebar-article:hover, .sidebar-article.active { background: #f3f4f6; color: #1a1dc3; }
.main-content { flex: 1; min-width: 0; padding: 32px 40px; overflow-y: auto; max-height: calc(100vh - 64px); }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 32px; }
.stat-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; text-align: center; }
.stat-card:hover { border-color: #1a1dc3; }
.stat-card-icon { font-size: 28px; margin-bottom: 8px; }
.stat-card-title { font-size: 13px; color: #6b7280; margin-bottom: 6px; }
.stat-card-value { font-size: 24px; font-weight: 700; }
.article-list { display: flex; flex-direction: column; gap: 8px; }
.article-item { display: block; padding: 16px; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; text-decoration: none; cursor: pointer; }
.article-item:hover { border-color: #1a1dc3; }
.article-item.active { border-color: #1a1dc3; background: #f3f4f6; }
.article-title { font-size: 16px; font-weight: 600; color: #1a1a1a; margin-bottom: 4px; }
.article-date { font-size: 12px; color: #9ca3af; }
.article-header { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb; }
.article-title-large { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
.article-meta { font-size: 13px; color: #9ca3af; }
.article-content { font-size: 15px; line-height: 1.8; }
.loading { text-align: center; padding: 40px; color: #9ca3af; }


@media (max-width: 900px) { .with-sidebar { flex-direction: column; } .sidebar-nav { width: 100%; border-right: none; border-bottom: 1px solid #e5e7eb; } }
</style>

<div class="with-sidebar">
  <aside class="sidebar-nav">
    <!-- æŠ•èµ„è®°å½• -->
    <div class="sidebar-group">
      <div class="sidebar-group-header">ğŸ“Š æŠ•èµ„è®°å½•</div>
      <div class="sidebar-links">
        <div class="sidebar-parent open" onclick="this.classList.toggle('open')">
          <span>ğŸ“ˆ</span>
          <span style="margin-left:8px">åªä¹°ä¸å–å®šæŠ•ä¸‰åå¹´</span>
          <i class="fas fa-chevron-right sidebar-chevron"></i>
        </div>
        <div class="sidebar-children">
          {{ range $yg := (sort ($dailyPages.GroupByDate "2006") "Key" "desc") }}
            <div class="sidebar-year" onclick="event.stopPropagation(); this.classList.toggle('open')">
              {{ $yg.Key }} å¹´
              <i class="fas fa-chevron-right sidebar-chevron" style="font-size:10px;margin-left:auto;"></i>
            </div>
            <div class="sidebar-months">
              {{ range $mg := (sort ($yg.Pages.GroupByDate "2006-01") "Key" "desc") }}
                {{ $ym := $mg.Key }}
                {{ $mn := (time (printf "%s-01" $ym)).Format "1" }}
                <div class="sidebar-month" data-month="{{ $ym }}">{{ $mn }}æœˆ</div>
              {{ end }}
            </div>
          {{ end }}
        </div>
      </div>
    </div>
    
    <!-- æŠ•èµ„å­¦ä¹  -->
    <div class="sidebar-group">
      <div class="sidebar-group-header">ğŸ’¡ æŠ•èµ„å­¦ä¹ </div>
      <div class="sidebar-links">
        <div class="sidebar-parent" onclick="this.classList.toggle('open')">
          <span>ğŸ“š</span>
          <span style="margin-left:8px">æ•´ç†ä¸æ€è€ƒ</span>
          <i class="fas fa-chevron-right sidebar-chevron"></i>
        </div>
        <div class="sidebar-children">
          {{ if gt (len $insightsPages) 0 }}
            {{ range sort $insightsPages "Date" "desc" }}
              <div class="sidebar-article" data-url="{{ .RelPermalink }}">{{ .Title }}</div>
            {{ end }}
          {{ else }}
            <div style="padding:8px 10px;font-size:13px;color:#9ca3af;">æš‚æ— æ–‡ç« </div>
          {{ end }}
        </div>
      </div>
    </div>
    
    <!-- æŠ•èµ„æ™ºæ…§ -->
    <div class="sidebar-group">
      <div class="sidebar-group-header">ğŸ’­ æŠ•èµ„æ™ºæ…§</div>
      <div class="sidebar-links">
        <div class="sidebar-parent" onclick="this.classList.toggle('open')">
          <span>ğŸ’¡</span>
          <span style="margin-left:8px">æŠ•èµ„ç­–ç•¥ä¸å“²æ€</span>
          <i class="fas fa-chevron-right sidebar-chevron"></i>
        </div>
        <div class="sidebar-children">
          {{ if gt (len $thoughtsPages) 0 }}
            {{ range sort $thoughtsPages "Date" "desc" }}
              <div class="sidebar-article" data-url="{{ .RelPermalink }}">{{ .Title }}</div>
            {{ end }}
          {{ else }}
            <div style="padding:8px 10px;font-size:13px;color:#9ca3af;">æš‚æ— æ–‡ç« </div>
          {{ end }}
        </div>
      </div>
    </div>
    
    <!-- æŠ€æœ¯æ ˆ -->
    <div class="sidebar-group">
      <div class="sidebar-group-header">âš¡ æŠ€æœ¯æ ˆ</div>
      <div class="sidebar-links">
        <div class="sidebar-parent" onclick="this.classList.toggle('open')">
          <span>ğŸ’»</span>
          <span style="margin-left:8px">æŠ€æœ¯æ´è§</span>
          <i class="fas fa-chevron-right sidebar-chevron"></i>
        </div>
        <div class="sidebar-children">
          {{ if gt (len $techPages) 0 }}
            {{ range sort $techPages "Date" "desc" }}
              <div class="sidebar-article" data-url="{{ .RelPermalink }}">{{ .Title }}</div>
            {{ end }}
          {{ else }}
            <div style="padding:8px 10px;font-size:13px;color:#9ca3af;">æš‚æ— æ–‡ç« </div>
          {{ end }}
        </div>
      </div>
    </div>
    
    <!-- æ‚æ–‡éšç¬” -->
    <div class="sidebar-group">
      <div class="sidebar-group-header">ğŸ“ æ‚æ–‡éšç¬”</div>
      <div class="sidebar-links">
        <div class="sidebar-parent" onclick="this.classList.toggle('open')">
          <span>ğŸ“</span>
          <span style="margin-left:8px">æ‚æ–‡éšç¬”</span>
          <i class="fas fa-chevron-right sidebar-chevron"></i>
        </div>
        <div class="sidebar-children">
          {{ if gt (len $essaysPages) 0 }}
            {{ range sort $essaysPages "Date" "desc" }}
              <div class="sidebar-article" data-url="{{ .RelPermalink }}">{{ .Title }}</div>
            {{ end }}
          {{ else }}
            <div style="padding:8px 10px;font-size:13px;color:#9ca3af;">æš‚æ— æ–‡ç« </div>
          {{ end }}
        </div>
      </div>
    </div>
  </aside>
  
  <main class="main-content" id="main-content">
    
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-card-icon">ğŸ“Š</div>
        <div class="stat-card-title">å®šæŠ•å¤©æ•°</div>
        <div class="stat-card-value">{{ $totalDays }} å¤©</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-icon">ğŸ’°</div>
        <div class="stat-card-title">å®šæŠ•æˆæœ¬</div>
        <div class="stat-card-value">${{ $cost }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-icon">ğŸ“ˆ</div>
        <div class="stat-card-title">æ”¶ç›Šç‡</div>
        <div class="stat-card-value">{{ $yield }}%</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-icon">ğŸ˜</div>
        <div class="stat-card-title">ææ…Œä¸è´ªå©ª</div>
        <div class="stat-card-value" id="fng-value">--</div>
      </div>
    </div>

    <div style="margin-bottom:16px;padding:12px;background:#f3f4f6;border-radius:8px;font-size:14px;color:#6b7280;">
      å·²å®šæŠ• {{ $totalDays }} å¤©ï¼Œå®šæŠ•æˆæœ¬ ${{ $cost }}ï¼Œæ”¶ç›Šç‡ {{ $yield }}%ï¼Œç»§ç»­åŠ æ²¹ ğŸ’ª
    </div>
    
    <div class="article-list" id="records-list">
      {{ range sort $dailyPages "Date" "desc" }}
      <div class="article-item" data-url="{{ .RelPermalink }}" data-date="{{ .Date.Format "2006-01" }}">
        <div class="article-title">{{ .Title }}</div>
        <div class="article-date">{{ .Date.Format "2006-01-02" }}</div>
      </div>
      {{ end }}
    </div>
  </main>
</div>

<script>
document.querySelectorAll('.sidebar-article').forEach(el => {
  el.addEventListener('click', function() {
    const url = this.getAttribute('data-url');
    if (!url) return;
    
    const contentArea = document.getElementById('main-content');
    
    document.querySelectorAll('.sidebar-article').forEach(a => a.classList.remove('active'));
    this.classList.add('active');
    
    contentArea.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
    
    fetch(url)
      .then(res => res.text())
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const articleContent = doc.querySelector('.main-content');
        
        if (articleContent) {
          contentArea.innerHTML = '' + articleContent.innerHTML;
          // é‡æ–°æ¸²æŸ“å›¾è¡¨
          if (window.Chart) {
            document.querySelectorAll('canvas[id^="chart-"]').forEach(function(canvas) {
              var cfgId = canvas.id + '-cfg';
              var cfgEl = document.getElementById(cfgId);
              if (cfgEl) {
                try {
                  var cfg = JSON.parse(cfgEl.textContent.trim());
                  new Chart(canvas.getContext('2d'), cfg);
                } catch(e) {}
              }
            });
          }
        } else {
          contentArea.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
        }
      })
      .catch(err => {
        contentArea.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
      });
  });
});

document.querySelectorAll('.sidebar-month').forEach(el => {
  el.addEventListener('click', function() {
    const month = this.getAttribute('data-month');
    document.querySelectorAll('.sidebar-month').forEach(m => m.classList.remove('active'));
    this.classList.add('active');
    
    document.querySelectorAll('.article-item').forEach(item => {
      if (item.dataset.date === month) {
        item.style.display = 'block';
      } else {
        item.style.display = 'none';
      }
    });
  });
});

document.querySelectorAll('.article-item').forEach(el => {
  el.addEventListener('click', function() {
    const url = this.getAttribute('data-url');
    if (!url) return;
    
    const contentArea = document.getElementById('main-content');
    
    document.querySelectorAll('.article-item').forEach(a => a.classList.remove('active'));
    this.classList.add('active');
    
    contentArea.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
    
    fetch(url)
      .then(res => res.text())
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const articleContent = doc.querySelector('.main-content');
        
        if (articleContent) {
          contentArea.innerHTML = '' + articleContent.innerHTML;
          // é‡æ–°æ¸²æŸ“å›¾è¡¨
          if (window.Chart) {
            document.querySelectorAll('canvas[id^="chart-"]').forEach(function(canvas) {
              var cfgId = canvas.id + '-cfg';
              var cfgEl = document.getElementById(cfgId);
              if (cfgEl) {
                try {
                  var cfg = JSON.parse(cfgEl.textContent.trim());
                  new Chart(canvas.getContext('2d'), cfg);
                } catch(e) {}
              }
            });
          }
        } else {
          contentArea.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
        }
      })
      .catch(err => {
        contentArea.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
      });
  });
});

fetch('https://api.alternative.me/fng/')
  .then(res => res.json())
  .then(data => {
    if (data.data && data.data[0]) {
      const value = data.data[0].value;
      const classification = data.data[0].value_classification;
      document.getElementById('fng-value').textContent = value + ' (' + classification + ')';
    }
  })
  .catch(err => {
    document.getElementById('fng-value').textContent = '--';
  });

// å¤„ç†URLå‚æ•°ï¼Œè‡ªåŠ¨ç­›é€‰æœˆä»½
const urlParams = new URLSearchParams(window.location.search);
const monthParam = urlParams.get('month');
if (monthParam) {
  document.querySelectorAll('.sidebar-month').forEach(el => {
    if (el.getAttribute('data-month') === monthParam) {
      el.click();
    }
  });
}
</script>

{{ end }}
